<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IO Extended 2018 Certificates</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/5.3.1/firebase-app.js"></script>
    <script defer src="/__/firebase/5.3.0/firebase-firestore.js">
    <script defer src="/__/firebase/5.3.1/firebase-database.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <link rel="stylesheet" href="/app.css">
  </head>
  <body>
    <form>
      <label for="email">Email</label>
      <input type="email" id="email">
      <button>Get Certificate</button>
    </form>

    <img src="/loading.gif" alt="" id="cert">

    <script>
      var genCertUrl = 'https://us-central1-gdg-cebu-cert-gen.cloudfunctions.net/generateCert?id=';
      function setCertImage(imageUrl) {
        if (!imageUrl) {
          imageUrl = '/loading.gif'
        }
        document.querySelector('#cert').setAttribute('src', imageUrl);
      }
      document.addEventListener('DOMContentLoaded', function() {
        var db = firebase.firestore();
        const settings = {timestampsInSnapshots: true};
        db.settings(settings);
        document.querySelector('form').addEventListener('submit', function(e) {
          e.preventDefault();
          var emailAd = document.querySelector('#email').value;
          db.collection('participants-io').
            where('email', '==', emailAd).get().then(snapshot => {
              if (snapshot.docs.length === 0) {
                console.log('no user');
                return;
              }
              var data = snapshot.docs[0].data();
              var id = snapshot.docs[0].id;
              if (data.imageUrl) {
                setCertImage(data.imageUrl);
              } else {
                var req = new Request(genCertUrl += id);
                fetch(req).then(resp => {
                  resp.text().then(setCertImage);
                });
              }
            });
        });
      });
    </script>
  </body>
</html>
